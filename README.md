# Climate
#### Description:
This program is my CS50 final project, which is composed of a main file (**app.py**), 3 assistant files (**helpers.py**, **helpers_data.py**, and **helpers_maps.py**), and 3 databases (**users.db**, **weather.db**, and **weather_update.db**).

To run this program, please use command `flask run`.

> [!NOTE]
> Becaues the original database ("static/weather.db") was too large to submit, I deleted most of its data. So, if you want to generate maps in the web page ("/maps"), please choose dates **between January 1950 and December 1952** or **between January 2021 and December 2023**.

1. **app.py** creates a web application, in which users can generate maps of climate data and check climate data history of a specific location. Users can also register and login as a administrator. Administrators have access to a web page called "/update", where they can add data to a temporary database, this temporary database can be merged into the main database if a higher-level administrator find no malicious data in it. Administrators can also change their profile icon or bio if they want to. 

    There are 10 functions in **app.py**.

    - `after_request(response)`:
    this is a function used to ensure responses aren't cached. Written by CS50 staff.

    - `index()`:
    it direct users to the homepage ("/index"). Homepage shows a gallery of maps and charts generated by this web application.

    - `locations()`:
    it direct users to the "/locations" page. Users can check the climate data history of a specific location.

    - `login()`:
    if users have registered, they can login from this page.

    - `logout()`:
    it logs the users out and clear the session.

    - `maps()`:
    it direct users to the "/maps" page. Users can generate maps of climate data in this page.

    - `profile()`:
    logging in is required before calling this function. It directs users to the "/profile" page. Users can change their profile icons and bios here.

    - `references()`:
    it directs users to the "/references" page, where the webpages I referred to are listed.  

    - `register()`:
    it direct users to the "/register" page, where users can register. The registered users are automatically registered as administrators. Their admin status can be managed in the database "static/users.db". Admin status is required before calling the function `update()`.

    - `update()`:
    direct logged in users to the "/update" page. Users with admin status are can update the temporary database "static/weather_update.db" in this page. This temporary database can be merged into the main database "static/weather.db" if there are no malicious data detected.

2. **helpers.py** contains 6 functions for the web application.

   - `apology(message, code=400)`: 
    this is a useful function written by CS50 staff. It will redirect users to a apology page when something goes wrong.

   - `draw_chart(lat, lon, df, filename=None)`: 
    it will draw a chart with a pandas.DataFrame (parameter name: `df`). Other parameters are used to name the chart. `lat`: latitude; `lon`: longitude; `filename`: name of the file to be saved as (if `filename` is None, the default filename will be `f"{lat}_{lon}.html`").

   - `is_valid_month(month, start="1950-01", end="2023-12")`:
    it can check whether the parameter `month` (format: "YYYY-mm") is valid (in between `start` and `end`) or not.

   - `is_valid_username(username)`: 
    it can check whether the parameter `username` is valid or not. `username` should only contain letters, numbers, underscores, and hyphens, with length between 3 and 16.

   - `login_required(f)`: 
    it's another powerful function written by CS50 staff. If a function in **app.py** can be called only when the user is logged in, we can use `login_required` to decorate that function.

   - `swap(a, b)`: 
    it simply swaps two variables.

3. **helpers_data.py** contains 6 functions which are used to deal with data
   
   - `fetch_loc_id(lat, lon, con=None)`: 
    it will return the id stored in the database of the location with the given latitude (parameter `lat`) and longitude(parameter `lon`). If the connection to a database (`con`) is None, the default database will be `"static/weather.db"`. ***Because this function will be called many times by other functions, passing connection will prevent the program connect and close the database too many times. Likewise for the following functions.***

   - `get_data(con=None, location=(0, 0), date_start="1950-01-01", date_end="1951-12-31", models=["MRI_AGCM3_2_S", "EC_Earth3P_HR"], meteo_types=["temperature_2m_mean", "temperature_2m_max", "temperature_2m_min", "precipitation_sum"], save_as_csv=False, insert_into_database=False, force_update_database=False, return_DataFrame=False)`:
   it can fetch data from [open-meteo.com](https://open-meteo.com/), save them as a csv file (if `save_as_csv` is True), and insert them into the database (if `insert_into_database` is True). `location`, `date_start`, and `date_end` specify the location and date range of the data. Models specify the source of data[^1]. `meteo_types` specify the type of data to be inserted. `force_update_database` determins whether to replace the data of a location whose data are already stored in the database or not. It will return a pandas.DataFrame if `return_DataFrame` is True. Otherwise, it will return True if success or False if failed. Functions `fetch_loc_id()`, `get_data_in_database()`, and `modify_database()` are called in this one.
   
   - `get_data_in_database(lat, lon, con=None)`: 
   it will fetch all data of a specified location from the database. `lat` and `lon` are the coordinates of the location and `con` is the connection to the database.

   - `get_data_locations(lats, lons, date_start="1950-01-01", date_end="1951-12-31", dbpath="static/weather.db", force_update_database=False)`:
   it will fetch data of multiple locations. `lats` and `lons` are the lists of latitudes and longitudes. For each point in the grid generated by these two lists, data from `date_start` and `date_end` will be downloaded from [open-meteo](https://open-meteo.com/) and stored in a database which is located at `dbpath`. `force_update_database` determins whether to replace the data of a location whose data are already stored in the database or not. Function `get_data()` is called in this one.

   - `modify_database(data, type="donothing", con=None)`:
   it will modify the database. `data` is a pandas.DataFrame which will be inserted into the database. If `type` is "insert", when a data of the same location and date already exists in the database, it will be skipped. If `type` is "update", such data will be replaced by the one in pandas.DataFrame. `con` is the connection to the database.

4. **helpers_maps.py** contains 7 functions which are used to generate maps.
   
   - `add_bounds(map)`:
   this function is used to add bounds along with latitude ±90° and longitude ±180° to the map. `map` is the map object to be dealt with.

   - `add_legend(map, climate_type)`:
   it is used to add legend to the map. If `climate_type` is "precip", colormap will be "Blues". If `climate_type` is "temp_*", colormap will be "coolwarm". `map` is the map object to be dealt with. 

   - `draw_multi_layers(start_date, end_date, climate_type)`:
    it will use `folium.raster_layers.ImageOverlay` multiple times to draw multiple layers on one map. This function is no longer used because I found it's not convenient to compare two maps in this case. So this function is replaced by the following function called `draw_multi_maps()`.

    - `draw_multi_maps(start_date, end_date, climate_type)`:
    it will generate multiple maps from `start_date` to `end_date` (one map each month) with only two layers, the first one is borders. `climate_type` will be passed to the function `add_legend()` and `fetch_data()`. Functions `add_bounds()`, `add_legend()`, `fetch_data()`, and `normalize_data()` are called.

    - `fetch_data(shape=(91, 91), date="1950-01-01", climate_type="temp_mean")`:
    it will fetch the data of the grid generated from a list of latitudes and a list of longitudes. `shape` specifies the lists of latitudes and longitudes (For example: `shape = (nlats, nlons)` means `lats = np.linspace(-90, 90, nlats)` and `lons = np.linspace(-180, 180, nlons)`). `date` is the date of interest. `climate_type` is the type of climate data of interest. Currently, there are 4 types stored in the database: mean, maxium, and minimum temperature ("temp_mean", "temp_max", and "temp_min") as well as precipitaion ("precip").
    
    - `generate_dates(start_date, end_date)`:
    it generates a list of the first dates of each month between `start_date` and `end_date`

    - `normalize_data(data, climate_type)`:
    it normalizes the data to make sure the legend keeps unchanged in different maps. 
     

[^1]: For example: "EC_Earth3P_HR" means data is provided by EC-Earth consortium, Rossby Center, Swedish Meteorological and Hydrological Institute/SMHI, Norrkoping, Sweden. There are 7 models available: "CMCC_CM2_VHR4", "FGOALS_f3_H", "HiRAM_SIT_HR", "MRI_AGCM3_2_S", "EC_Earth3P_HR", "MPI_ESM1_2_XR", "NICAM16_8S". More information at [open-meteo](https://open-meteo.com/en/docs/climate-api).
